# Production-specific overrides
# Use with: docker compose -f docker-compose.yml -f docker-compose.prod.yml up

services:
  backend:
    build:
      target: production
    volumes:
      - backend_static:/app/staticfiles
      - backend_media:/app/media
    env_file:
      - .env
    environment:
      - DEBUG=0
    command: gunicorn counter_backend.wsgi:application --bind 0.0.0.0:8000 --workers 3 --timeout 120
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'

  frontend:
    # Use pre-built image from build-and-deploy-frontend.ps1
    # The script builds it with: docker build -f frontend/Dockerfile.simple -t app-frontend:latest
    image: app-frontend:latest
    # Don't build - use the pre-built image
    build:
      context: ./frontend
      dockerfile: Dockerfile.simple

  # Nginx reverse proxy for production
  nginx:
    image: nginx:alpine
    container_name: app-nginx
    ports:
      - "80:80"
      # - "443:443"  # enable after SSL certs are in place
    volumes:
      # Mount as a site config (server {} is valid here)
      - ./infra/nginx/nginx.http.conf:/etc/nginx/conf.d/default.conf:ro
      # - ./infra/nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro  # (not valid: contains server{} only)
      # - /etc/letsencrypt:/etc/letsencrypt:ro  # enable after SSL certs exist
      - backend_static:/var/www/static
      - backend_media:/var/www/media
    depends_on:
      - backend
      - frontend
    networks:
      - app-network
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 64M
          cpus: '0.1'